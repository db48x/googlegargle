#!/bin/bash
#./listerine - a companion to the google gargle project
#relies on googlegrape, aria2c, curl, and youtube-dl

# Change the username below to something unique to you. ALPHANUMERIC ONLY!
USERNAME=
SERVER=199.48.254.90:8081
GARGLE=./googlegargle

if [ -z $USERNAME ]; then
    echo "$0: You must edit the listerine script and add a username before you can begin">&2
    exit 1
fi

if [ ! -f $GARGLE ]; then
    echo "$0: Couldn't find googlegargle. Are you sure you cloned everything from the git repository?">&2
    exit 2
fi

EXTERN_IP=`curl --silent ipv4.icanhazip.com` #Do not change without good reason, or underscor will eat your brains

curl -s http://$SERVER/introduce/$USERNAME/$EXTERN_IP
echo ""
while true
do
	echo "Getting an id from $SERVER, authenticated as $USERNAME with IP $EXTERN_IP"
	id=`curl --silent http://$SERVER/getID/$USERNAME | sed "s/[^0-9\\-]//g"`

	echo ID is $id
	$GARGLE -- "$id"

	SEPDIB=$(echo "$id" | sed 's/-//g' | cut -c1)
	SECDIB=$(echo "$id" | sed 's/-//g' | cut -c2)
	THIRDIB=$(echo "$id" | sed 's/-//g' | cut -c3)
	hash=`sha1sum "$SEPDIB/$SECDIB/$THIRDIB/$id/$id.flv"|awk '{print $1}'`
	size=`du -b "$SEPDIB/$SECDIB/$THIRDIB/$id/$id.flv"|awk '{print $1}'`
	echo "Hash is $hash"
	echo "ID is $id"
	echo "USERNAME is $USERNAME"
	echo "Size is $size"
	curl "http://$SERVER/finishVid/$USERNAME/$id/$size/$hash"
        if [ -f STOP ]; then 
		echo "I see a file called STOP. Stopping."
		exit 0
	fi
done
